<%- include("partials/header") %> <%- include("partials/patientSideBar") %>
<div class="container-fluid patientclass">
  <div class="row justify-content-center">
    <div class="offset-2 col-9 offset-sm-2 col-sm-8 offset-lg-0 col-lg-6 p-1">
      <h1 class="text-center p-2">
        <%=i18n.Takeyour %> <span class="blue"><%=i18n.tests %></span> <%=i18n.now %>
        <i class="fas fa-calendar-check blue"></i>
      </h1>
    </div>
  </div>

  <%- include("partials/testTabs") %>

  <div class="row p-1 justify-content-center">
    <% let i=0,c_pending=0,c_paused=0,c_completed=0%>
    <% tests.forEach((test) => { %>
    <div class="offset-2 col-9 offset-sm-1 col-sm-10 offset-lg-0 col-lg-5 p-2 <%=test.status%> test<%=i%>" id='test_list'>
      <div class="card box-shadow p-3">
        <div class="row align-items-center">
          <div class="col-sm-6 my-auto">
            <img
              src="/images/exam.svg"
              class="card-img-top rounded-circle p-1 box-shadow"
              alt="..."
              style="border: 3px solid #6c63ff"
            />
          </div>
          <div class="col-sm-6">
            <div class="card-body">
              <h5 class="card-title p-1"><%=i18n.Test%>  <i class="fas fa-bell blue"></i></h5>
              <p class="card-text p-1">
                <i class="fas fa-question-circle blue"></i> : <%=test.noofquestion%>
              </p>
              <p class="card-text p-1"><%=i18n.Level%> : 
                <%for(let i=1;i<=5;i++){%>
                  <%if(i<=test.level){%>
                    <span class = "fa fa-star checked"></span>
                  <%} else{%>
                    <span class = "fa fa-star unchecked"></span>
                  <%}%>
                <%}%>
                </p>
              <div class="d-flex justify-content-end">
                <% if(test.status != 'completed') { %>
                  <% if(test.status == "pending") {%>
                    <button class="btn btn-lg btn-primary white" onclick="test_execute('<%=test._id%>')">
                      <%=i18n.Starttest%> <i class="fas fa-play"></i>
                    </button>
                    <% c_pending=c_pending+1%>
                  <%}else{%> 
                    <button class="btn btn-lg btn-secondary white" onclick="test_execute('<%=test._id%>')">
                      <%=i18n.Resume%> <i class="fab fa-rev"></i>
                    </button>
                    <% c_paused=c_paused+1%>
                  <%}%>
                <%}else{%>
                  <button class="btn btn-lg btn-success white"  data-bs-toggle="modal" data-bs-target="#viewReport" data-bs-whatever="<%=test._id%>"><%=i18n.ViewReport%> <i class="fas fa-poll"></i>
                  </button>
                  <% c_completed=c_completed+1%>
                <%}%>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% i=i+1%>
    <% }) %>
  </div>
</div>

<%- include("partials/viewReportModal") %>

<script type="text/javascript">
$(window).on('load', function() {
  create_chart();
  count_number_of_tests('all',parseInt('<%=tests.length %>'));
  count_number_of_tests('pending',parseInt('<%=c_pending %>'));
  count_number_of_tests('paused',parseInt('<%=c_paused %>'));
  count_number_of_tests('completed',parseInt('<%=c_completed %>'));
});

document.getElementById('all').addEventListener('click',function(){
  for(var i=0;i<parseInt('<%=tests.length %>');i++){
      document.getElementsByClassName('test'+i)[0].classList.remove('d-none');
  }
  count_number_of_tests('all',parseInt('<%=tests.length %>'))
});
document.getElementById('paused').addEventListener('click',function(){
  for(var i=0;i<parseInt('<%=tests.length %>');i++){
      document.getElementsByClassName('test'+i)[0].classList.add('d-none');
  }
  let paused=document.getElementsByClassName('paused');
  for(let i=0;i<paused.length;i++){
    paused[i].classList.remove('d-none');
  }
});
document.getElementById('pending').addEventListener('click',function(){
  for(var i=0;i<parseInt('<%=tests.length %>');i++){
      document.getElementsByClassName('test'+i)[0].classList.add('d-none');
  }
  let pending=document.getElementsByClassName('pending');
  for(let i=0;i<pending.length;i++){
    pending[i].classList.remove('d-none');
  }
});
document.getElementById('completed').addEventListener('click',function(){
  for(var i=0;i<parseInt('<%=tests.length %>');i++){
      document.getElementsByClassName('test'+i)[0].classList.add('d-none');
  }
  let completed=document.getElementsByClassName('completed');
  for(let i=0;i<completed.length;i++){
    completed[i].classList.remove('d-none');
  }
});

function count_number_of_tests(status,count) {
  document.getElementById(status).innerHTML='<strong style="text-transform: capitalize;">'+returnStatus(status)+'</strong><span class="badge bg-danger ms-2">'+count+'</span>';
}

function returnStatus(status){
  if(status === "all"){
    return '<%=i18n.All%>';
  }else if(status === "pending"){
    return '<%=i18n.Pending%>'
  }else if(status === "completed"){
    return '<%=i18n.Completed%>'
  }else {
    return '<%=i18n.Paused%>'
  }
}


//------------------RES CHART------------------
var data = {
          labels: [
          "<%=i18n.Correctanswerd%>",
              "<%=i18n.Wronganswerd%>",
          ],
          datasets: [
              {
                  data: [0, 100],
                  backgroundColor: [
                      "#10ba00",
                      "#ff3300",
                      
                  ],
                  hoverBackgroundColor: [
                      "#0b8000",
                      "#e62e00",
                  ]
              }]
      };
      var myDoughnutChart;
//------------------END------------------

  function test_execute(id){
    var win = window.open("/start/test/"+id);
    var timer = setInterval(function() {
        if (win.closed) {
            clearInterval(timer);
            window.location.reload();
        }
    }, 500);
  }

  var viewReport = document.getElementById('viewReport')
  viewReport.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var testid = button.getAttribute('data-bs-whatever')
    fetch('/test/'+testid)
      .then(response => response.json())
      .then(test=>{
        test_res(test.score,test.noofquestion)
      });
  })
  function test_res(s,n){
    let total=n*100;
    let per=(s/total)*100;
    let score=document.getElementById('score');
    let grade=document.getElementById('grade');
    let msg=document.getElementById('msg');
    score.textContent=s+'/'+total;
    if(per<40){
      grade.textContent='<%=i18n.POOR%>';
      msg.textContent='<%=i18n.BePatientWorkHardandgetsuccess%>'
    }else if(per>=40 && per<60){
      grade.textContent='<%=i18n.AVERAGE%>';
      msg.textContent='<%=i18n.YourdoinggoodjobKeepitup%>'
    }else if(per>=60 && per<80){
      grade.textContent='<%=i18n.GOOD%>';
      msg.textContent='<%=i18n.gettingbettercontinuehardwork%>'
    }else{
      grade.textContent='<%=i18n.EXCELLENT%>';
      msg.textContent='<%=i18n.hardworkpaidoff%>'
    }
    res_in_chart(per)
  }

  function create_chart(){
      var ctx = document.getElementById("res_Chart");
      myDoughnutChart = new Chart(ctx, {
          type: 'doughnut',
          data: data,
          options: {
            rotation:  86* Math.PI,
            circumference: 57.25 * Math.PI
          }
      });
  }

  function res_in_chart(per){
    data.datasets[0].data=[per,100-per]
    myDoughnutChart.data.datasets[0].data=[per,100-per];
    myDoughnutChart.update();
  }


</script>

<%- include("partials/footer") %>
