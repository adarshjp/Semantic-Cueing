<%- include("partials/header") %> <%- include("partials/patientSideBar") %>
<div class="container patientclass">
  <div class="row justify-content-center">
    <div class="offset-2 col-9 offset-sm-2 col-sm-8 offset-lg-0 col-lg-6 p-1">
      <h1 class="text-center p-2">
        Take your <span class="blue">tests</span> now
        <i class="fas fa-calendar-check blue"></i>
      </h1>
    </div>
  </div>
  <div class="row p-1 justify-content-center">
    <% tests.forEach((test) => { %>
    <div class="offset-2 col-9 offset-sm-1 col-sm-10  offset-lg-0 col-lg-6 p-1">
      <div class="card box-shadow p-3">
        <div class="row">
          <div class="col-md-6 my-auto">
            <img
              src="/images/exam.svg"
              class="card-img-top rounded-circle p-1 box-shadow"
              alt="..."
              style="border: 3px solid #6c63ff"
            />
          </div>
          <div class="col-md-6">
            <div class="card-body">
              <h5 class="card-title">Test<i class="fas fa-bell blue"></i></h5>
              <p class="card-text">
                <i class="fas fa-question-circle blue"></i>:
                <%=test.noofquestion%>
              </p>
              <p class="card-text">Level: <%=test.level%></p>
              <div class="d-flex justify-content-end">
                <% if(test.status != 'completed') { %>
                  <% if(test.status == "pending") {%>
                    <button class="btn btn-lg btn-primary white" onclick="test_execute('<%=test._id%>')">
                      Start test <i class="fas fa-play"></i>
                    </button>
                  <%}else{%> 
                    <button class="btn btn-lg btn-secondary white" onclick="test_execute('<%=test._id%>')">
                      Resume <i class="fab fa-rev"></i>
                    </button>
                  <%}%>
                <%}else{%>
                  <button class="btn btn-lg btn-success white"  data-bs-toggle="modal" data-bs-target="#viewReport" data-bs-whatever="<%=test._id%>">
                    View Report <i class="fas fa-poll"></i>
                  </button>
                <%}%>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<%- include("partials/viewReportModal") %>

<script type="text/javascript">
$(window).on('load', function() {
  create_chart();
});
//------------------RES CHART------------------
var data = {
          labels: [
              "Correct answerd",
              "Wrong answerd",
          ],
          datasets: [
              {
                  data: [0, 100],
                  backgroundColor: [
                      "#10ba00",
                      "#ff3300",
                      
                  ],
                  hoverBackgroundColor: [
                      "#0b8000",
                      "#e62e00",
                  ]
              }]
      };
      var myDoughnutChart;
//------------------END------------------

  function test_execute(id){
    var win = window.open("/start/test/"+id);
    var timer = setInterval(function() {
        if (win.closed) {
            clearInterval(timer);
            window.location.reload();
        }
    }, 500);
  }

  var viewReport = document.getElementById('viewReport')
  viewReport.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var testid = button.getAttribute('data-bs-whatever')
    fetch('/test/'+testid)
      .then(response => response.json())
      .then(test=>{
        test_res(test.score,test.noofquestion)
      });
  })
  function test_res(s,n){
    let total=n*100;
    let per=(s/total)*100;
    let score=document.getElementById('score');
    let grade=document.getElementById('grade');
    let msg=document.getElementById('msg');
    score.textContent=s+'/'+total;
    if(per<40){
      grade.textContent='POOR';
      msg.textContent='Be Patient, Work Hard and you will surely get success'
    }else if(per>=40 && per<60){
      grade.textContent='AVERAGE';
      msg.textContent='Your doing a good job, Keep it up!'
    }else if(per>=60 && per<80){
      grade.textContent='GOOD';
      msg.textContent='Your getting better & better, continue the hard work'
    }else{
      grade.textContent='EXCELLENT';
      msg.textContent='"Congratulations! Your hard work paid off"'
    }
    res_in_chart(per)
  }

  function create_chart(){
      var ctx = document.getElementById("res_Chart");
      myDoughnutChart = new Chart(ctx, {
          type: 'doughnut',
          data: data,
          options: {
            rotation:  86* Math.PI,
            circumference: 57.25 * Math.PI
          }
      });
  }

  function res_in_chart(per){
    data.datasets[0].data=[per,100-per]
    myDoughnutChart.data.datasets[0].data=[per,100-per];
    myDoughnutChart.update();
  }


</script>

<%- include("partials/footer") %>
