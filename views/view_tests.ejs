<%- include("partials/header") %> 
<%- include("partials/doctorSideBar") %>
<div class="container-fluid">
  <%- include("partials/flashMsg") %>
  <div class="row justify-content-center">
    <div class="offset-2 col-9 offset-sm-1 col-sm-9 offset-lg-0 col-lg-6 p-1">
      <h1 class="text-center p-2">
        <%=i18n.Listof%><span class="blue"> <%=i18n.Tests%></span> 
        <%=i18n.Created%> <i class="fas fa-calendar-check blue"></i>
      </h1>
    </div>
  </div>
  <%- include("partials/testTabs") %>
  <%- include("partials/no_Test") %>
  <div class="row p-1 justify-content-center" id='test_status'>
    <div class="offset-2 col-8 offset-sm-1 col-sm-10 offset-lg-0 col-lg-11 text-center mb-3">
      <a href="/create/test" class="btn btn-primary btn-lg rounded-pill"><%=i18n.CreateTest%> <i class="fa-solid fa-plus"></i></a>
    </div>
    <div class="offset-2 col-9 offset-sm-1 col-sm-10 offset-lg-0">
      <div class="row p-0 justify-content-center">
        <% let k=1,c_pending=0,c_paused=0,c_completed=0%>
        <% tests.forEach((test) => { %>
        <div class="col-12 col-sm-9 col-md-8 col-lg-6 col-xl-4 p-2 <%=test.status%> test<%=k-1%>" id='test_list'>
          <div class="card box-shadow border border-2">
            <div class="card-header">
              <div class="row align-items-center">
                <div class="col-5 mt-2">
                  <h5 class="card-title"><%=i18n.Test %> <i class="fas fa-bell blue"></i></h5>
                </div>
                <div class="col-7 text-end">
                  <%if(test.status==='pending'){%>
                    <a class="btn btn-lg btn-primary white mx-1 rounded-pill d-inline-block" href='/edit/test/<%=test._id%>'
                      ><i class="fas fa-edit"></i></a>
                      <form action="/delete/test/<%=test._id%>?_method=DELETE" method="POST" class="d-inline-block">
                        <button class="btn btn-lg btn-danger rounded-pill white" type="submit">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                      <% c_pending=c_pending+1%>
                  <%}else if(test.status === 'completed'){%>
                    <button class="btn btn-lg btn-success rounded-pill white" type="button" disabled>
                      <i class="fa-solid fa-check-to-slot"></i>
                    </button>
                    <% c_completed=c_completed+1%>
                  <%}else{%>
                    <% c_paused=c_paused+1%>
                    <button class="btn btn-lg btn-secondary white rounded-pill" type="button" disabled><i class="fa-solid fa-pause"></i></button>
                  <%}%>
                </div>
              </div>
            </div>
            <div class="card-body">
              <p class="card-text p-1"><i class="fas fa-question-circle blue"></i> : <%=test.noofquestion%></p>
              <p class="card-text p-1"><%=i18n.Level%> : 
                <%for(let i=1;i<=5;i++){%>
                  <%if(i<=test.level){%>
                    <span class = "fa fa-star checked"></span>
                  <%} else{%>
                    <span class = "fa fa-star unchecked"></span>
                  <%}%>
                <%}%>
              </p>
              <p class="card-text p-1"><%=i18n.Status%> : <strong style="text-transform: capitalize;"><%=test.status%></strong></p>
              <div class="text-center mb-2">
                <button class="btn btn-primary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#test<%=k%>" aria-expanded="false">
                  <%=i18n.ViewPatients%> <i class="fa-solid fa-eye"></i>
                </button>
              </div>
              <div class="collapse table-responsive" id="test<%=k%>">
                <table class="table table-hover table-bordered text-center">
                  <thead>
                    <tr>
                      <th scope="col"><%=i18n.Name%></th>
                      <th scope="col"><%=i18n.Status%></th>
                      <%if(test.status==='completed'){%>
                        <th scope="col"><%=i18n.ViewReport%></th>
                      <%}else{%>
                        <th scope="col"><%=i18n.NoQsattemted%></th>
                      <%}%>
                    </tr>
                  </thead>
                  <tbody>
                    <% test.patients.forEach((patient) => { %>
                      <tr>
                        <td class="<%=patient.patientid%>"></td>
                        <td style="text-transform: capitalize;"><%=patient.status%></td>
                      <%if(test.status==='completed'){%>
                        <td>
                          <button class="btn btn-lg btn-success white rounded-pill"  data-bs-toggle="modal" data-bs-target="#viewReport" data-bs-whatever="<%=patient.score%>,<%=test.noofquestion%>">
                            <i class="fas fa-poll"></i>
                          </button>
                          <a class="btn btn-lg btn btn-primary white rounded-pill" href="/chat/<%=patient.patientid%>"><i class="fa-solid fa-message"></i></a>
                      </td>
                      <%}else{%>
                        <td><%=patient.pauesdqno%></td>
                      <%}%>
                      </tr>
                    <%})%>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <%k=k+1%>
        <% }) %>
      </div>
    </div>
  </div>
</div>
<%- include("partials/viewReportModal") %>
<script src='/view_tests.js'></script>
<script>
  let total_test=parseInt('<%=tests.length %>')
  let no_test='<%=i18n.NoTest_doctor%>';
  let no_test1='<%=i18n.isAssigned_doctor%>';
  let no_test2='<%=i18n.NoTest%>';
  let no_pending='<%=i18n.isPending%>';
  let no_paused='<%=i18n.isPaused%>';
  let no_complete='<%=i18n.Completed%>';
  $(window).on('load', function() {
    count_number_of_tests('all',parseInt('<%=tests.length %>'),'<%=i18n.All%>');
    count_number_of_tests('pending',parseInt('<%=c_pending %>'),'<%=i18n.Pending%>');
    count_number_of_tests('paused',parseInt('<%=c_paused %>'),'<%=i18n.Paused%>');
    count_number_of_tests('completed',parseInt('<%=c_completed %>'),'<%=i18n.Completed%>');
    disp_test_or_no_test('all',total_test)
    patient_names();
    create_chart()
  });

//------------------RES CHART------------------
var data = {
          labels: [
              "<%=i18n.Correctanswerd%>",
              "<%=i18n.Wronganswerd%>",
          ],
          datasets: [
              {
                  data: [0, 100],
                  backgroundColor: [
                      "#10ba00",
                      "#ff3300",
                      
                  ],
                  hoverBackgroundColor: [
                      "#0b8000",
                      "#e62e00",
                  ]
              }]
      };
      var myDoughnutChart;
//------------------END------------------

  var viewReport = document.getElementById('viewReport')
  viewReport.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget
    var test_details = button.getAttribute('data-bs-whatever').split(',');
    test_res(test_details[0], test_details[1]);
  })

  function patient_names(){
    fetch('/data/patientnames/<%=user._id%>')
    .then(response => response.json())
    .then(patients=>{
      patients.forEach((patient) => {
        var patient_name = document.getElementsByClassName(patient._id)
        for(var xy=0;xy<patient_name.length;xy++){
          patient_name[xy].textContent=patient.name
        }
      })
    });
  }

  function test_res(s,n){
    let total=n*100;
    let per=(s/total)*100;
    let score=document.getElementById('score');
    score.textContent=s+'/'+total;
    res_in_chart(per)
  }

  function create_chart(){
      var ctx = document.getElementById("res_Chart");
      myDoughnutChart = new Chart(ctx, {
          type: 'doughnut',
          data: data,
          options: {
            rotation:  86* Math.PI,
            circumference: 57.25 * Math.PI
          }
      });
  }

  function res_in_chart(per){
    myDoughnutChart.data.datasets[0].data=[per,100-per];
    myDoughnutChart.update();
  }
</script>
<%- include("partials/footer") %>