<%- include("partials/header") %>
<%- include("partials/doctorSideBar") %>
<main id="test-main" class="container">
    <div class="row justify-content-center">
        <div class="offset-2 col-9 offset-sm-1 col-sm-9  offset-lg-0 col-lg-12">
            <div class="row justify-content-center">
                <div class="col-10 col-sm-6">
                    <label for="level">Choose Level <i class="fa fa-filter" aria-hidden="true"></i></label>
                    <select  class="form-select form-select-lg my-2 p-2" id="level" aria-label=".form-select-lg" onclick="levelfilter()">
                        <option value="all">All</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="col-2 col-sm-2">
                    <button type="button" class="btn btn-primary position-relative rounded-pill" onclick="showSelectedQuestion()" style="margin-top:35px">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="count">0</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4" style="margin-top:30px">
                    <button class="btn btn-primary rounded-pill btn-lg" onclick="reSet();">Reset <i class="fa fa-refresh" aria-hidden="true"></i></button>
                </div>
                <div class="col-10 col-sm-7 col-md-6" style="margin-top:30px">
                    <button class="btn btn-primary rounded-pill btn-lg" onclick="selRandom();">Select randomly <i class="fa fa-random" aria-hidden="true"></i></button>
                </div>
            </div>
            <form action="/create/test" method="POST" id="testForm" onsubmit="return noofqval();">
                    <ol class="gradient-list" id='ol_list'>
                        <% var i=1;%>
                        <% question.forEach((question)=>{ %>
                            <li class="row shadow-lg mb-5 bg-body rounded-lg <%= question.level%>" id="question<%=i%>">
                                <div class="card-image p-2">
                                    <div class="inputGroup">
                                        <input id="option<%=i%>" class="form-check-input question<%=i%> op<%=question.level%>" type="checkbox"  value="<%=question._id %>" name="questions" onclick="countQuestion()">
                                        <label for="option<%=i%>">Question : <strong><%=question.answer%></strong></label> 
                                    </div>
                                    <div class="hover-img">
                                        <span class="p-1 rounded-lg my-3" id="qimg">
                                            <img src="data:image/<%=question.question.contentType%>;base64,<%=question.question.data.toString('base64')%>" alt="image" class="img-fluid" style="max-height: 18rem;"/>      
                                        </span>
                                    </div>
                                </div>   
                            </li>
                            <%i++;%>
                        <% }) %>
                    </ol>
                <div class="d-flex justify-content-center d-none" id="loader">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="row justify-content-center mt-4">
                    <div class="col-6">
                        <label for="patient">Choose Patient</label>
                        <select name="patientid" id="doctorid" class="form-select form-select-lg my-2 p-2" aria-label=".form-select-lg" required>
                            <% patient.forEach((patient)=> { %>
                                <option value="<%=patient._id%>"><%=patient.name%></option>
                            <% }) %>
                          </select>
                    </div>
                    <div class="col-6">
                        <label for="level">Enter Level</label>
                        <input type="number" name="level" id="login-input" placeholder="1-5" onchange="checklevel(this.value)" required/>
                    </div>
                </div>
                <div class="text-center p-3">
                    <input type="submit" class="btn btn-primary btn-lg rounded-pill" value="Create Test" id="formsubmit"/>
                </div>
                </div>
            </form>
        </div>
    </div>
    
</main>
<script>

    let k=1;   //multiplier used to skip questions 5,10,15 so on...
    let li_id=parseInt('<%=i%>'); //used in input and labels
    let isCompleted=false; //true is no more questions

    function countQuestion(){
        document.getElementById('count').textContent = document.querySelectorAll('input[type="checkbox"]:checked').length;
    }

    function reSet(){
        for(var i=1;i<=li_id-1;i++){
            document.getElementById("option"+i).checked = false;
        }
        countQuestion();
    }
    function noofqval() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        if(checkboxes.length<5){
            alert("Please select atleast 5 questions..");
            return false;
        }
        else{
            var ele=document.getElementById("formsubmit");
            ele.disabled=true;
            ele.value="Creating..."
            return true;
        }
    }
    function selRandom(){
        var num=li_id-1;
        var ran;
        var cur_level=document.getElementById("level").value;
        for(var i=1;i<=num;i++){
            document.getElementById("option"+i).checked = false;
        }
        if(cur_level=="all"){
            for(var i=0;i<Math.min(num,5);){
                ran=Math.floor(Math.random() * num) + 1;
                if(!(document.getElementById("option"+ran).checked)){
                    document.getElementById("option"+ran).checked = true;
                    i++;
                }
            }
        }
        else{
            var m=Math.min(num,Math.min(document.getElementsByClassName(cur_level).length,10))
            for(var i=0;i<m;){
                ran=Math.floor(Math.random() * m);
                if(!(document.getElementsByClassName("op"+cur_level)[ran].checked)){
                    document.getElementsByClassName("op"+cur_level)[ran].checked=true;
                    i++;
                }
            }
        }
        document.getElementById("level").value='all';
        countQuestion();
    }
    function showhidelevel(levclass,disp){
        for(var i=0;i<levclass.length;i++){
            levclass[i].style.display=disp;
        }
    }
    function levelfilter(){
        var level=document.getElementById("level").value;
        var levclass;
        if(level!="all"){
            for(var i=1;i<=5;i++){
                if(level==i){
                    levclass=document.getElementsByClassName(level)
                    showhidelevel(levclass,"block")
                }
                else{
                    levclass=document.getElementsByClassName(i)
                    showhidelevel(levclass,"none")
                }
            }
        }
        else{
            for(var i=1;i<=5;i++){
                var levclass=document.getElementsByClassName(i)
                showhidelevel(levclass,"block")
            }
        }
    }
    function showSelectedQuestion(){
        var num=li_id-1;
        for(var i=1;i<=num;i++){
            if(document.getElementsByClassName('question'+i)[0].checked){
                document.getElementById('question'+i).style.display="block";
            }
            else{
                document.getElementById('question'+i).style.display="none";
            }
        }
        document.getElementById("level").value='all';
    }

    window.onscroll = function(ev) {
        if (!isCompleted && ((window.innerHeight + window.scrollY+1) >= document.body.offsetHeight)) {
            document.getElementById('loader').classList.remove('d-none')
            fetch('/create/test/'+(k*5))
            .then(response => response.json())
            .then(question=>{
                if(question.message==="No more questions")
                {
                    document.getElementById('loader').classList.add('d-none');
                    isCompleted=true;
                    alert("No more questions")
                    return
                }
                for(let q=0;q<question.question.length;q++) {
                    append_li(question.question[q]);
                }
                document.getElementById('loader').setAttribute('hidden','');
            });
            k=k+1;
        }
    };

    function append_li(q){
        let li=document.createElement("li");
        li.className='row shadow-lg mb-5 bg-body rounded-lg '+q.level;
        li.id='question'+li_id;

        let card_img=document.createElement('div');
        card_img.className='card-image p-2';

        let inputGroup=document.createElement('div');
        inputGroup.className='inputGroup';

        let input=document.createElement('input');
        input.id="option"+li_id;
        input.className='form-check-input question'+li_id+' op'+q.level;
        input.type="checkbox";
        input.value=q._id;
        input.name='questions';
        input.setAttribute('onclick','countQuestion()');

        let label=document.createElement('label');
        label.setAttribute('for','option'+li_id);

        let strong=document.createElement('strong');
        strong.textContent=q.answer;

        label.textContent='Question : ';
        label.appendChild(strong);
        let hover_img=document.createElement('div');
        hover_img.className='hover-img';

        let span=document.createElement('span');
        span.className='p-1 rounded-lg my-3';
        span.id='qimg';

        let img=document.createElement('img');
        img.className='img-fluid';
        img.alt='image';
        img.style.cssText='max-height: 18rem;'
        img.src='data:image/'+q.question.contentType+';base64,'+arrayBufferToBase64(q.question.data.data);
        
        span.appendChild(img);
        hover_img.appendChild(span);
        inputGroup.appendChild(input);
        inputGroup.appendChild(label);

        card_img.appendChild(inputGroup);
        card_img.appendChild(hover_img);

        li.appendChild(card_img);

        document.getElementById('ol_list').appendChild(li);
        li_id++;
    }

    function arrayBufferToBase64(buffer) {
      var binary = '';
      var bytes = [].slice.call(new Uint8Array(buffer));
      bytes.forEach((b) => binary += String.fromCharCode(b));
      return window.btoa(binary);
    };
</script>
<%- include("partials/footer") %>
