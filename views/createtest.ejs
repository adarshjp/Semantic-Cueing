<%- include("partials/header") %>
<%- include("partials/doctorSideBar") %>
  <div class="tab-content" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab"></div>
    <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab"></div>
  </div>
<div class="container-fluid">
    <div class="row justify-content-center">
        <nav class="offset-2 col-9 offset-sm-1 col-sm-10 offset-md-0 col-md-10">
            <div class="nav nav-tabs nav-justified flex-column flex-sm-row" id="nav-tab" role="tablist">
              <button class="nav-link active py-3 h6" id="sel-q-tab" data-bs-toggle="tab" data-bs-target="#div_list" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Select Questions</button>
              <button class="nav-link py-3 h6" id="selected-q-tab" data-bs-toggle="tab" data-bs-target="#div_list" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Selected Questions</button>
            </div>
        </nav>
        <div class="offset-2 col-9 offset-sm-1 col-sm-5 offset-md-1 col-md-4 mt-sm-2" id='ch_level'>
            <label for="level">Choose Level <i class="fa fa-filter" aria-hidden="true"></i></label>
            <select  class="form-select form-select-lg my-2 p-2" id="level" aria-label=".form-select-lg" onclick="levelfilter()">
                <option value="all">All</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>
        <div class="offset-2 offset-sm-0 col-9 col-sm-5 col-md-4 text-center" style="margin-top:30px" id='sel_ran'>
            <button class="btn btn-primary rounded-pill btn-lg" onclick="selRandom();">Select randomly <i class="fa fa-random" aria-hidden="true"></i></button>
        </div>
    </div>
    <form action="/create/test" method="POST" id="testForm" onsubmit="return noofqval();">
        <div class="row justify-content-center gradient-list mb-2" id='div_list'>
            <% var i=1;%>
            <% question.forEach((question)=>{ %>
                <div class="offset-2 col-8 offset-sm-1 col-sm-9 offset-md-1 col-md-5 offset-xl-0 col-xl-5 <%if(i%2==0){%>offset-md-0 mx-md-3<%}%> shadow-lg bg-body rounded-lg <%= question.level%>" id="question<%=i%>">
                    <div class="card-image mx-0 p-2">
                        <div class="inputGroup">
                            <input id="option<%=i%>" class="form-check-input question<%=i%> op<%=question.level%>" type="checkbox"  value="<%=question._id %>" name="questions">
                            <label for="option<%=i%>">Question : <strong><%=question.answer%></strong></label> 
                        </div>
                        <div class="hover-img">
                            <span class="p-1 rounded-lg my-3" id="qimg">
                                <img src="data:image/<%=question.question.contentType%>;base64,<%=question.question.data.toString('base64')%>" alt="image" class="img-fluid" style="max-height: 12rem;"/>      
                            </span>
                        </div>
                    </div>   
                </div>
                <%i++;%>
            <% }) %>
        </div>
    <div class="d-flex justify-content-center d-none blue my-4" id="loader">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="row justify-content-center mt-4 d-none" id="pat_lev">
        <div class="offset-2 col-9 offset-sm-1 col-sm-5 offset-md-1 col-md-4 offset-lg-0">
            <label for="patient">Choose Patient</label>
            <select name="patientid" id="doctorid" class="form-select form-select-lg my-2 p-2" aria-label=".form-select-lg" required>
                <% patient.forEach((patient)=> { %>
                    <option value="<%=patient._id%>"><%=patient.name%></option>
                <% }) %>
              </select>
        </div>
        <div class="offset-2 col-9 offset-sm-0 col-sm-5 offset-md-0 col-md-4">
            <label for="level">Enter Level</label>
            <input type="number" name="level" id="login-input1" placeholder="1-5" onchange="checklevel(this.value)" required/>
        </div>
    </div>
    <div class="text-end text-sm-center p-2 d-none" id="res_but">
        <button class="btn btn-primary rounded-pill btn-lg" onclick="reSet();">Reset <i class="fa fa-refresh" aria-hidden="true"></i></button>
        <input type="submit" class="btn btn-primary btn-lg rounded-pill" value="Create Test" id="formsubmit"/>
    </div>
    </form>
</div>

<script>
    let k=1;   //multiplier used to skip questions 5,10,15 so on...
    let li_id=parseInt('<%=i%>'); //used in input and labels
    let isCompleted=false; //true is no more questions
    let temp=isCompleted;

    document.getElementById('sel-q-tab').addEventListener('click', function(){
        for(var i=1;i<li_id;i++){
            document.getElementById('question'+i).style.display="block";
        }
        isCompleted=temp;
        document.getElementById('sel_ran').classList.remove('d-none');
        document.getElementById('ch_level').classList.remove('d-none');
        document.getElementById('pat_lev').classList.add('d-none');
        document.getElementById('res_but').classList.add('d-none');
    });

    document.getElementById('selected-q-tab').addEventListener('click', function(){
        showSelectedQuestion();
        temp=isCompleted;
        isCompleted=true;
        document.getElementById('sel_ran').classList.add('d-none');
        document.getElementById('ch_level').classList.add('d-none');
        document.getElementById('pat_lev').classList.remove('d-none');
        document.getElementById('res_but').classList.remove('d-none');
    });

    // function countQuestion(){
    //     document.getElementById('count').textContent = document.querySelectorAll('input[type="checkbox"]:checked').length;
    // }

    function reSet(){
        for(var i=1;i<=li_id-1;i++){
            document.getElementById("option"+i).checked = false;
        }
        showSelectedQuestion()
    
    }

    function noofqval() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        if(checkboxes.length<5){
            alert("Please select atleast 5 questions..");
            return false;
        }
        else{
            var ele=document.getElementById("formsubmit");
            ele.disabled=true;
            ele.value="Creating..."
            return true;
        }
    }

    function selRandom(){
        var num=li_id-1;
        var ran;
        var cur_level=document.getElementById("level").value;
        for(var i=1;i<=num;i++){
            document.getElementById("option"+i).checked = false;
        }
        if(cur_level=="all"){
            for(var i=0;i<Math.min(num,5);){
                ran=Math.floor(Math.random() * num) + 1;
                if(!(document.getElementById("option"+ran).checked)){
                    document.getElementById("option"+ran).checked = true;
                    i++;
                }
            }
        }
        else{
            var m=Math.min(num,Math.min(document.getElementsByClassName(cur_level).length,10))
            for(var i=0;i<m;){
                ran=Math.floor(Math.random() * m);
                if(!(document.getElementsByClassName("op"+cur_level)[ran].checked)){
                    document.getElementsByClassName("op"+cur_level)[ran].checked=true;
                    i++;
                }
            }
        }
        document.getElementById("level").value='all';
    }
    function showhidelevel(levclass,disp){
        for(var i=0;i<levclass.length;i++){
            levclass[i].style.display=disp;
        }
    }
    function levelfilter(){
        var level=document.getElementById("level").value;
        var levclass;
        if(level!="all"){
            for(var i=1;i<=5;i++){
                if(level==i){
                    levclass=document.getElementsByClassName(level)
                    showhidelevel(levclass,"block")
                }
                else{
                    levclass=document.getElementsByClassName(i)
                    showhidelevel(levclass,"none")
                }
            }
        }
        else{
            for(var i=1;i<=5;i++){
                var levclass=document.getElementsByClassName(i)
                showhidelevel(levclass,"block")
            }
        }
    }
    function showSelectedQuestion(){
        var num=li_id-1;
        for(var i=1;i<=num;i++){
            if(document.getElementsByClassName('question'+i)[0].checked){
                document.getElementById('question'+i).style.display="block";
            }
            else{
                document.getElementById('question'+i).style.display="none";
            }
        }
        document.getElementById("level").value='all';
    }

    window.onscroll = function(ev) {
        if (!isCompleted && ((window.innerHeight + window.scrollY+1) >= document.body.offsetHeight)) {
            document.getElementById('loader').classList.remove('d-none')
            fetch('/create/test/'+(k*5))
            .then(response => response.json())
            .then(question=>{
                if(question.message==="No more questions")
                {
                    document.getElementById('loader').classList.add('d-none');
                    isCompleted=true;
                    alert("No more questions")
                    return
                }
                for(let q=0;q<question.question.length;q++) {
                    append_li(question.question[q]);
                }
                document.getElementById('loader').setAttribute('hidden','');
            });
            k=k+1;
        }
    };

    function append_li(q){
        let div=document.createElement("div");
        
        div.className='offset-2 col-8 offset-sm-1 col-sm-9 offset-md-1 col-md-5 offset-xl-0 col-xl-5 shadow-lg bg-body rounded-lg '+q.level;
        if(li_id%2==0){
            div.classList.add('offset-md-0')
            div.classList.add('mx-md-3')
        }
        div.id='question'+li_id;

        let card_img=document.createElement('div');
        card_img.className='card-image mx-0 p-2';

        let inputGroup=document.createElement('div');
        inputGroup.className='inputGroup';

        let input=document.createElement('input');
        input.id="option"+li_id;
        input.className='form-check-input question'+li_id+' op'+q.level;
        input.type="checkbox";
        input.value=q._id;
        input.name='questions';
        input.setAttribute('onclick','countQuestion()');

        let label=document.createElement('label');
        label.setAttribute('for','option'+li_id);

        let strong=document.createElement('strong');
        strong.textContent=q.answer;

        label.textContent='Question : ';
        label.appendChild(strong);
        let hover_img=document.createElement('div');
        hover_img.className='hover-img';

        let span=document.createElement('span');
        span.className='p-1 rounded-lg my-3';
        span.id='qimg';

        let img=document.createElement('img');
        img.className='img-fluid';
        img.alt='image';
        img.style.cssText='max-height: 18rem;'
        img.src='data:image/'+q.question.contentType+';base64,'+arrayBufferToBase64(q.question.data.data);
        
        span.appendChild(img);
        hover_img.appendChild(span);
        inputGroup.appendChild(input);
        inputGroup.appendChild(label);

        card_img.appendChild(inputGroup);
        card_img.appendChild(hover_img);

        div.appendChild(card_img);

        document.getElementById('div_list').append(div);
        li_id++;
    }

    function arrayBufferToBase64(buffer) {
      var binary = '';
      var bytes = [].slice.call(new Uint8Array(buffer));
      bytes.forEach((b) => binary += String.fromCharCode(b));
      return window.btoa(binary);
    };
</script>
<%- include("partials/footer") %>
